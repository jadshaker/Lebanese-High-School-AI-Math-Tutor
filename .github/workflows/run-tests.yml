name: Run Tests with RunPod

on:
  workflow_run:
    workflows: ["Pre Merge Checks"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

jobs:
  test-with-runpod:
    runs-on: ubuntu-latest
    # Only run if pre-merge checks succeeded (or manual trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start Docker Services
        run: |
          docker compose up -d
          echo "Waiting for services to start..."
          sleep 10

      - name: Create RunPod Pod
        id: create-pod
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
        run: |
          echo "Creating RunPod A40 pod with ollama/ollama image..."

          # Create pod using GraphQL API
          RESPONSE=$(curl -s -X POST \
            "https://api.runpod.io/graphql?api_key=$RUNPOD_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { podFindAndDeployOnDemand(input: { cloudType: SECURE, gpuTypeId: \"NVIDIA A40\", name: \"ci-test-pod\", imageName: \"ollama/ollama\", dockerArgs: \"\", ports: \"11434/http\", volumeInGb: 50, containerDiskInGb: 50, env: [{ key: \"OLLAMA_HOST\", value: \"0.0.0.0\" }] }) { id imageName env machineId machine { podHostId } } }"
            }')

          echo "Response: $RESPONSE"

          # Extract pod ID from response
          POD_ID=$(echo "$RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

          if [ -z "$POD_ID" ]; then
            echo "✗ Failed to create pod"
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "✓ Pod created with ID: $POD_ID"
          echo "pod_id=$POD_ID" >> $GITHUB_OUTPUT

      - name: Wait for Pod Ready
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          POD_ID: ${{ steps.create-pod.outputs.pod_id }}
        run: |
          echo "Waiting for pod $POD_ID to be ready..."

          TIMEOUT=600
          ELAPSED=0
          INTERVAL=15

          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Check pod status
            RESPONSE=$(curl -s -X POST \
              "https://api.runpod.io/graphql?api_key=$RUNPOD_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{
                "query": "query { pod(input: {podId: \"'"$POD_ID"'\"}) { id desiredStatus runtime { uptimeInSeconds } } }"
              }')

            STATUS=$(echo "$RESPONSE" | grep -o '"desiredStatus":"[^"]*"' | cut -d'"' -f4)

            echo "Status: $STATUS (elapsed: ${ELAPSED}s)"

            if [ "$STATUS" = "RUNNING" ]; then
              RUNTIME=$(echo "$RESPONSE" | grep -o '"uptimeInSeconds":[0-9]*' | cut -d':' -f2)
              if [ -n "$RUNTIME" ] && [ "$RUNTIME" -gt 0 ]; then
                echo "✓ Pod is running (uptime: ${RUNTIME}s)"
                break
              fi
            fi

            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "✗ Timeout waiting for pod to start"
            exit 1
          fi

      - name: Wait for Ollama Ready
        env:
          POD_ID: ${{ steps.create-pod.outputs.pod_id }}
        run: |
          OLLAMA_URL="https://${POD_ID}-11434.proxy.runpod.net"
          echo "Waiting for Ollama at: $OLLAMA_URL"

          TIMEOUT=180
          ELAPSED=0
          INTERVAL=10

          while [ $ELAPSED -lt $TIMEOUT ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$OLLAMA_URL/api/tags" || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ Ollama is responding"
              break
            fi

            echo "Waiting for Ollama (HTTP $HTTP_CODE)..."
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "✗ Timeout waiting for Ollama"
            exit 1
          fi

      - name: Pull and Load Models
        env:
          POD_ID: ${{ steps.create-pod.outputs.pod_id }}
        run: |
          OLLAMA_URL="https://${POD_ID}-11434.proxy.runpod.net"
          echo "Loading models on: $OLLAMA_URL"

          # Pull deepseek-r1:7b (may take a while to download)
          echo "Pulling deepseek-r1:7b..."
          curl -X POST "$OLLAMA_URL/api/pull" \
            -H "Content-Type: application/json" \
            -d '{"name": "deepseek-r1:7b"}' \
            --max-time 600

          if [ $? -eq 0 ]; then
            echo "✓ deepseek-r1:7b pulled"
          else
            echo "✗ Failed to pull deepseek-r1:7b"
            exit 1
          fi

          # Load deepseek-r1:7b with keep_alive
          echo "Loading deepseek-r1:7b into memory..."
          curl -X POST "$OLLAMA_URL/api/generate" \
            -H "Content-Type: application/json" \
            -d '{"model": "deepseek-r1:7b", "prompt": "Hello", "stream": false, "keep_alive": -1}' \
            --max-time 300 > /dev/null

          if [ $? -eq 0 ]; then
            echo "✓ deepseek-r1:7b loaded"
          else
            echo "✗ Failed to load deepseek-r1:7b"
            exit 1
          fi

          # Pull tinyllama:latest
          echo "Pulling tinyllama:latest..."
          curl -X POST "$OLLAMA_URL/api/pull" \
            -H "Content-Type: application/json" \
            -d '{"name": "tinyllama:latest"}' \
            --max-time 300

          if [ $? -eq 0 ]; then
            echo "✓ tinyllama:latest pulled"
          else
            echo "✗ Failed to pull tinyllama:latest"
            exit 1
          fi

          # Load tinyllama:latest with keep_alive
          echo "Loading tinyllama:latest into memory..."
          curl -X POST "$OLLAMA_URL/api/generate" \
            -H "Content-Type: application/json" \
            -d '{"model": "tinyllama:latest", "prompt": "Hello", "stream": false, "keep_alive": -1}' \
            --max-time 120 > /dev/null

          if [ $? -eq 0 ]; then
            echo "✓ tinyllama:latest loaded"
          else
            echo "✗ Failed to load tinyllama:latest"
            exit 1
          fi

          echo ""
          echo "✓ All models loaded successfully"

      - name: Run Integration Tests
        env:
          POD_ID: ${{ steps.create-pod.outputs.pod_id }}
          SMALL_LLM_SERVICE_URL: https://${{ steps.create-pod.outputs.pod_id }}-11434.proxy.runpod.net
          FINE_TUNED_MODEL_SERVICE_URL: https://${{ steps.create-pod.outputs.pod_id }}-11434.proxy.runpod.net
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Running integration tests with RunPod..."
          python3 cli.py test tests/integration/ --use-real-apis -v

      - name: Run E2E Tests
        env:
          POD_ID: ${{ steps.create-pod.outputs.pod_id }}
          SMALL_LLM_SERVICE_URL: https://${{ steps.create-pod.outputs.pod_id }}-11434.proxy.runpod.net
          FINE_TUNED_MODEL_SERVICE_URL: https://${{ steps.create-pod.outputs.pod_id }}-11434.proxy.runpod.net
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Running E2E tests with RunPod..."
          python3 cli.py test tests/e2e/ --use-real-apis -v

      - name: Stop Docker Services
        if: always()
        run: |
          docker compose down

      - name: Terminate RunPod Pod
        if: always()
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          POD_ID: ${{ steps.create-pod.outputs.pod_id }}
        run: |
          if [ -n "$POD_ID" ]; then
            echo "Terminating RunPod pod: $POD_ID"

            curl -s -X POST \
              "https://api.runpod.io/graphql?api_key=$RUNPOD_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{
                "query": "mutation { podTerminate(input: {podId: \"'"$POD_ID"'\"}) }"
              }'

            echo ""
            echo "✓ Pod terminated"
          else
            echo "No pod ID found, skipping cleanup"
          fi
